<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jessie Math - ä¹˜ä»¥å¹¾åˆ†ä¹‹ä¸€</title> 

  <!-- âœ… å¿«å–é€£çµé è¦½ï¼ˆè«‹æ”¾åœ¨ <head> è£¡ï¼‰ -->
  <meta name="description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
  <!-- âœ… LINE / FB é è¦½ç”¨ -->
  <meta property="og:title" content="Jessie Math - ä¹˜ä»¥å¹¾åˆ†ä¹‹ä¸€">
  <meta property="og:description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
  <meta property="og:type" content="website">

  <!-- âœ… é è¦½åœ–ç‰‡ï¼ˆæŠŠæª”åæ›æˆä½ çš„ä¸»é¡Œåœ–ï¼Œä¾‹å¦‚ g5-u9.pngï¼‰ -->
  <meta property="og:image" content="g5-u9.png">
  <meta property="og:image:width" content="1024">
  <meta property="og:image:height" content="1536">
  <meta property="og:image:alt" content="Jessie Math éŠæˆ²å°é¢">

  <!-- âœ… æœ‰äº›å¹³å°æœƒåƒè€ƒ -->
  <link rel="image_src" href="g5-u9.png">

  <!-- âœ… Twitter / Xï¼ˆå¯ç”¨åŒä¸€å¼µåœ–ï¼‰ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Jessie Math - ä¹˜ä»¥å¹¾åˆ†ä¹‹ä¸€">
  <meta name="twitter:description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
  <meta name="twitter:image" content="g5-u9.png">

  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #6366f1;
      --secondary: #a855f7;
      --accent: #10b981;
      --bg: #f8fafc;
      --card-bg: rgba(255, 255, 255, 0.75);
      --card-border: rgba(255, 255, 255, 0.4);
      --text-main: #1e293b;
      --text-muted: #64748b;
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
      --radius-lg: 24px;
      --radius-md: 16px;

      --brand-yellow: #FFD700;

      --hero-bg: #ffffff;
      --hero-border: rgba(15, 23, 42, 0.08);
      --hero-pill: rgba(248, 250, 252, 0.9);
      --hero-pill-border: rgba(15, 23, 42, 0.10);
      --hero-pill-active-border: rgba(99, 102, 241, 0.45);
    }

    * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    
    body {
      margin: 0;
      font-family: 'Plus Jakarta Sans', 'Noto Sans TC', sans-serif;
      color: var(--text-main);
      background: #f1f5f9;
      background-image: 
        radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.1) 0px, transparent 50%),
        radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.1) 0px, transparent 50%);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .wrap { max-width: 1000px; margin: 0 auto; padding: 24px 20px 28px; }

    header.hero {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 18px;

      padding: 14px 18px;
      background: var(--hero-bg);
      border: 1px solid var(--hero-border);
      border-radius: 18px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
      position: sticky;
      top: 14px;
      z-index: 100;
    }

    .brand { display:flex; align-items:center; gap: 14px; min-width: 0; }

    .brandMark{
      width: 48px;
      height: 48px;
      border-radius: 999px;
      background: transparent;
      position: relative;
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }
    .brandMark::before{
      content:"";
      position:absolute;
      inset: -2px;
      border-radius: 999px;
      border: 4px solid var(--brand-yellow);
      box-shadow: 0 10px 18px -12px rgba(245, 158, 11, 0.55);
    }
    .brandMark img{ width: 80%; height: auto; display:block; }

    .title{ min-width:0; }
    .title h1{
      margin:0;
      font-size: 1.9rem;
      font-weight: 900;
      letter-spacing: -0.8px;
      line-height: 1.05;
      white-space: nowrap;
    }
    .title p{
      margin: 2px 0 0 0;
      font-size: 0.85rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .nav{
      display:flex;
      align-items:center;
      gap: 12px;
      flex: 0 0 auto;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      border: 1px solid var(--hero-pill-border);
      cursor: pointer;
      padding: 12px 16px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: var(--hero-pill);
      color: var(--text-main);
      box-shadow: 0 2px 10px rgba(15, 23, 42, 0.04);
      text-decoration: none;
      user-select: none;
      justify-content:center;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(15, 23, 42, 0.07);
      border-color: rgba(99, 102, 241, 0.35);
    }
    .btn i{ font-size: 1.05rem; }

    .btn.good{
      background: rgba(255,255,255,0.95);
      border: 2px solid var(--hero-pill-active-border);
      color: #4f46e5;
    }
    .btn.good:hover{
      border-color: rgba(99, 102, 241, 0.7);
      box-shadow: 0 14px 26px rgba(79, 70, 229, 0.14);
    }

    .btn.disabled,
    .btn:disabled{
      opacity: 0.55;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: 0 2px 10px rgba(15, 23, 42, 0.04) !important;
      border-color: var(--hero-pill-border) !important;
    }

    .screen { display: none; animation: fadeIn 0.5s ease; }
    .screen.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(16px);
      border-radius: var(--radius-lg);
      border: 1px solid var(--card-border);
      box-shadow: var(--glass-shadow);
      margin-top: 24px; padding: 32px;
    }

    .tag {
      font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
      padding: 4px 12px; border-radius: 20px;
      background: rgba(99, 102, 241, 0.1); color: var(--primary);
      margin-bottom: 12px; display: inline-block;
    }

    .inp {
      width: 100%; padding: 16px; border-radius: var(--radius-md);
      border: 1px solid #e2e8f0; background: rgba(255,255,255,0.5);
      font-size: 1rem; outline: none;
    }
    .inp:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

    .panel { background: rgba(255,255,255,0.4); padding: 24px; border-radius: var(--radius-md); border: 1px solid rgba(255,255,255,0.5); }

    .introGrid{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 16px;
      margin-top: 16px;
    }
    .infoCard{
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,255,255,0.6);
      border-radius: var(--radius-md);
      padding: 18px;
    }
    .infoTitle{
      display:flex; align-items:center; gap:10px;
      font-weight:800; margin:0 0 8px 0;
    }
    .infoList{
      margin: 0;
      padding-left: 18px;
      color: var(--text-muted);
      line-height: 1.8;
      font-size: 0.95rem;
    }
    .miniHint{
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .levelCards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin: 20px 0; }
    .lvl {
      padding: 24px; border-radius: var(--radius-md); background: white;
      border: 2px solid transparent; cursor: pointer; text-align: center;
      position: relative;
    }
    .lvl:hover { transform: scale(1.02); }
    .lvl.active { border-color: var(--primary); background: rgba(99, 102, 241, 0.02); }
    .lvl b { display: block; margin-top: 12px; font-size: 1rem; }

    .hudRow { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; gap: 10px; flex-wrap: wrap; }
    .pillMini {
      padding: 8px 16px; border-radius: 30px; background: white;
      font-size: 0.85rem; font-weight: 700; border: 1px solid #e2e8f0;
      white-space: nowrap;
    }

    .timeBar { height: 6px; background: #e2e8f0; border-radius: 10px; margin: 20px 0; overflow: hidden; }
    .timeFill { height: 100%; width: 100%; background: var(--primary); border-radius: 10px; transform-origin: left; }

    .equation {
      font-size: 2.5rem; font-weight: 900; display: flex; align-items: center;
      justify-content: center; gap: 24px; padding: 34px 0 18px;
      flex-wrap: wrap;
    }

    .frac {
      display: inline-flex; flex-direction: column; align-items: center;
      background: white; padding: 12px 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
      font-weight: 900;
    }
    .frac .line { width: 34px; height: 3px; background: var(--text-main); margin: 4px 0; border-radius: 2px; }

    .frac.sm{
      padding: 10px 16px;
      border-radius: 14px;
      box-shadow: none;
      border: 1px solid #e2e8f0;
      background: rgba(255,255,255,0.95);
      font-size: 1.05rem;
    }
    .frac.sm .line{ width: 28px; height: 3px; }

    .box { background: white; padding: 16px 28px; border-radius: 16px; border: 1px solid #e2e8f0; }

    .quick { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 18px; }
    .qbtn {
      padding: 18px; border-radius: var(--radius-md); background: white;
      border: 1px solid #e2e8f0; cursor: pointer;
      display: flex; justify-content: center; align-items: center;
      min-height: 86px;
    }
    .qbtn:hover { border-color: var(--primary); transform: translateY(-1px); }

    .overlay {
      position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 200;
    }
    .overlay.show { display: flex; }
    .modal {
      background: white; width: min(520px, 92%); border-radius: var(--radius-lg);
      padding: 40px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .lb { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .lb th { text-align: left; color: var(--text-muted); font-size: 0.75rem; padding-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
    .lb td { padding: 16px 0; border-top: 1px solid #f1f5f9; font-size: 0.9rem; }
    .rankCell { color: var(--primary); font-weight: 800; width: 40px; }

    /* ===== Big feedback used in L1/L2/L3 ===== */
    .bigFeedback{
      border-radius: 18px;
      padding: 16px 18px;
      font-weight: 1000;
      text-align:center;
      font-size: 1.35rem;
      line-height: 1.45;
      border: 1px solid rgba(15,23,42,0.08);
      background: rgba(255,255,255,0.75);
      box-shadow: 0 18px 28px rgba(15,23,42,0.08);
      margin-top: 14px;
    }
    .bigFeedback.ok{
      border-color: rgba(16,185,129,0.35);
      background: rgba(16,185,129,0.08);
    }
    .bigFeedback.bad{
      border-color: rgba(244,63,94,0.35);
      background: rgba(244,63,94,0.08);
    }
    .answerLine{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    /* ===== L3-A ===== */
    .l3Wrap{ display:grid; gap: 16px; }
    .l3TopHint{
      font-weight: 900;
      color: var(--text-muted);
      display:flex; align-items:center; justify-content:center;
      gap: 10px;
      text-align:center;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .dropSlot{
      min-width: 120px;
      height: 72px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 16px;
      border: 2px dashed rgba(99,102,241,0.45);
      background: rgba(99,102,241,0.06);
      font-weight: 1000;
      color: rgba(99,102,241,0.9);
      box-shadow: inset 0 0 0 3px rgba(255,255,255,0.4);
      padding: 6px 10px;
    }
    .dropSlot.hover{
      background: rgba(99,102,241,0.12);
      transform: translateY(-1px);
    }
    .dragGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .dragChip{
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 14px 10px;
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor: grab;
      box-shadow: 0 8px 18px rgba(15,23,42,0.06);
      user-select:none;
      min-height: 86px;
    }
    .dragChip:active{ cursor: grabbing; transform: scale(0.98); }
    .dragChip.locked{
      opacity: 0.55;
      cursor: not-allowed;
      transform: none !important;
    }

    /* ===== L3-B ===== */
    .l3bGrid{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 18px;
      margin-top: 8px;
    }
    .l3bBox{
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,255,255,0.6);
      border-radius: var(--radius-md);
      padding: 18px;
    }
    .l3bTitle{
      font-weight: 1000;
      display:flex; align-items:center; gap:10px;
      margin:0 0 10px 0;
    }
    .l3bSub{
      margin: 0 0 14px 0;
      color: var(--text-muted);
      font-weight: 800;
      font-size: 0.9rem;
      line-height: 1.55;
    }

    .meaningCards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .meaningCard{
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 14px 14px;
      font-weight: 900;
      display:flex; align-items:center; gap:10px;
      cursor: grab;
      user-select:none;
      box-shadow: 0 8px 18px rgba(15,23,42,0.06);
      min-height: 56px;
      line-height: 1.35;
    }
    .meaningCard i{ color: var(--primary); }
    .meaningCard.locked{ opacity: .55; cursor:not-allowed; box-shadow:none; }

    .pairArea{ display:grid; gap: 12px; }
    .pairSlot{
      border-radius: 18px;
      border: 2px dashed rgba(99,102,241,0.45);
      background: rgba(99,102,241,0.06);
      padding: 14px;
    }
    .pairSlot.hover{ background: rgba(99,102,241,0.12); transform: translateY(-1px); }
    .slotHead{
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .slotBadge{
      font-weight: 1000;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.85);
      border: 1px solid rgba(15,23,42,0.10);
      display:inline-flex; align-items:center; gap:8px;
      white-space: nowrap;
    }
    .slotFill{
      min-height: 56px;
      border-radius: 14px;
      background: rgba(255,255,255,0.75);
      border: 1px solid rgba(15,23,42,0.08);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 12px;
      text-align:center;
      font-weight: 1000;
      line-height: 1.45;
    }
    .slotEmpty{ color: rgba(99,102,241,0.85); font-weight: 1000; }

    .pairActions{
      display:flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .btnGreen{
      background: rgba(16,185,129,0.12);
      border: 1px solid rgba(16,185,129,0.30);
      color: #0f766e;
      font-weight: 1000;
      border-radius: 14px;
      padding: 12px 14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      flex: 1;
      min-width: 140px;
    }
    .btnGreen:hover{ background: rgba(16,185,129,0.18); transform: translateY(-1px); }
    .btnGray{
      background: rgba(148,163,184,0.14);
      border: 1px solid rgba(148,163,184,0.35);
      color: #334155;
      font-weight: 1000;
      border-radius: 14px;
      padding: 12px 14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      flex: 1;
      min-width: 140px;
    }
    .btnGray:hover{ background: rgba(148,163,184,0.20); transform: translateY(-1px); }

    /* ===== Game action row ===== */
    .gameActions{
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .gameActions .btn{
      border-radius: 14px;
      flex: 1;
      min-width: 180px;
    }

    /* ===== Footer ===== */
    footer{
      max-width: 1000px;
      margin: 14px auto 28px;
      padding: 0 20px;
    }
    .footer-pill{
      background: rgba(255,255,255,0.70);
      border: 1px solid rgba(255,255,255,0.55);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: 999px;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      box-shadow: 0 10px 26px rgba(15,23,42,0.06);
      flex-wrap: wrap;
    }
    .footer-left, .footer-right{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 900;
      color: rgba(30,41,59,0.88);
      flex-wrap: wrap;
    }
    .footer-dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: var(--brand-yellow);
      box-shadow: 0 10px 18px -12px rgba(245, 158, 11, 0.65);
    }
    .footer-copy{ font-size: 0.88rem; color: rgba(30,41,59,0.72); font-weight: 900; }
    .footer-icon{
      width: 28px; height: 28px; border-radius: 999px;
      background: rgba(99,102,241,0.12);
      border: 1px solid rgba(99,102,241,0.20);
      display:grid; place-items:center;
      color: #4f46e5;
    }
    .footer-tagline{ font-size: 0.92rem; color: rgba(30,41,59,0.82); font-weight: 1000; }

    /* ===== RWD ===== */
    @media (max-width: 860px){
      .introGrid{ grid-template-columns: 1fr; }
      header.hero{ padding: 14px 14px; }
      .btn{ padding: 12px 14px; }
      .title h1{ font-size: 1.55rem; }
      .equation{ font-size: 2.15rem; padding: 28px 0 14px; gap: 16px; }
      .l3bGrid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 520px){
      .wrap{ padding: 18px 14px 24px; }
      .card{ padding: 22px; }
      .equation{ font-size: 1.85rem; gap: 12px; }
      .quick{ gap: 12px; }
      .qbtn{ min-height: 78px; }
      .dragGrid{ grid-template-columns: repeat(2, 1fr); }
      .meaningCards{ grid-template-columns: 1fr; }
      .bigFeedback{ font-size: 1.12rem; padding: 14px 14px; }
      .footer-pill{ border-radius: 22px; }
    }

    #fxCanvas { position: fixed; inset: 0; pointer-events: none; z-index: 999; }
  </style>
</head>

<body>
  <canvas id="fxCanvas"></canvas>

  <div class="wrap">
    <header class="hero">
      <div class="brand">
        <div class="brandMark" aria-label="Jessie Math Logo">
          <img src="JESSIEMATH-Q.png" alt="Jessie Math Q" />
        </div>
        <div class="title">
          <h1>Jessie Math</h1>
          <p>äº”å¹´ç´šï½œä¹˜ä»¥å¹¾åˆ†ä¹‹ä¸€</p>
        </div>
      </div>

      <div class="nav">
        <a class="btn" href="https://jessiemath0703-chu.github.io/website2/" title="é¦–é ">
          <i class="fa-solid fa-house"></i> é¦–é 
        </a>

        <a class="btn" href="https://jessiemath0703-chu.github.io/Game-Lobby/" title="éŠæˆ²å¤§å»³">
          <i class="fa-solid fa-gamepad"></i> éŠæˆ²å¤§å»³
        </a>

        <a class="btn good" href="https://jessiemath0703-chu.github.io/Game-Lobby/#g5-u9" title="å›åˆ°äº”å¹´ç´šä¹˜ä»¥å¹¾åˆ†ä¹‹ä¸€">
          <i class="fa-solid fa-rotate-left"></i> äº”å¹´ç´šä¹˜ä»¥å¹¾åˆ†ä¹‹ä¸€
        </a>
      </div>
    </header>

    <section class="screen active" id="screenIntro">
      <div class="card">
        <span class="tag">å¿…å¡«ç™»å…¥</span>
        <h2 style="font-size: 1.8rem; margin-top: 0;">å…ˆç•™ä¸‹ä½ çš„åå­—ï¼Œæ‰è®“ä½ é€²å ´ ğŸ˜¼</h2>
        <p style="color: var(--text-muted); margin-bottom: 18px;">
          é€™ä¸æ˜¯åˆé›£ï¼Œæ˜¯ç‚ºäº†æŠŠä½ çš„æˆé•·è»Œè·¡è¨˜ä¸‹ä¾†ï¼šåˆ†æ•¸ä¹Ÿæœƒæœ‰è¨˜æ†¶ï¼ŒåŠªåŠ›æ›´è¦æœ‰ã€‚
        </p>

        <div class="introGrid">
          <div class="panel">
            <label for="nameInput" style="display:block; font-weight:800; margin-bottom:10px;">
              ç©å®¶åç¨±ï¼ˆå¿…å¡«ï¼‰
            </label>
            <input class="inp" id="nameInput" placeholder="ä¾‹å¦‚ï¼šæ·æå°å®‡å®™" maxlength="12" autocomplete="off" />
            <div class="miniHint">
              å°æé†’ï¼šæœ€å¤š 12 å­—ï¼Œæ’è¡Œæ¦œæœƒç”¨é€™å€‹åå­—å‡ºç¾ã€‚
            </div>

            <div style="margin-top: 18px;">
              <button class="btn good disabled" id="btnGoMenu" disabled style="width: 100%; justify-content:center; padding: 16px; border-radius: 14px;">
                é€²å…¥ä¸»é¸å–® <i class="fa-solid fa-arrow-right"></i>
              </button>
            </div>
          </div>

          <div class="infoCard">
            <p class="infoTitle"><i class="fa-solid fa-circle-info" style="color:var(--primary)"></i> éŠæˆ²ä»‹ç´¹</p>
            <ul class="infoList">
              <li><b>ç©æ³•ï¼š</b>ç¬¬ 1ã€2 é—œé¸ç­”æ¡ˆï¼›ç¬¬ 3 é—œç‚ºæ‹–æ‹‰é¡Œå‹ï¼ˆå«å…©ç¨®æ¨¡å¼ï¼‰ã€‚</li>
              <li><b>è¨ˆæ™‚ï¼š</b>æ¯å›åˆ <b>60 ç§’</b>ï¼Œæ™‚é–“æ­¸é›¶å°±æ”¶å·¥ã€‚</li>
              <li><b>è¨ˆåˆ†ï¼š</b>ç­”å°åŠ åˆ†ï¼ˆé›£åº¦è¶Šé«˜åŠ è¶Šå¤šï¼‰ï¼Œç­”éŒ¯ Combo æ­¸é›¶ã€‚</li>
              <li><b>å›é¥‹ï¼š</b>ç­”å°ï¼ç­”éŒ¯éƒ½æœƒåœ¨é¡Œç›®å€é¡¯ç¤ºå›é¥‹èˆ‡æ­£ç¢ºç­”æ¡ˆã€‚</li>
              <li><b>æ’è¡Œæ¦œï¼š</b>åŒé—œå¡ï¼‹åŒé›£åº¦å„è‡ªè¨˜éŒ„ TOP 10ã€‚</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <section class="screen" id="screenMenu">
      <div class="card">
        <div class="hudRow">
          <div>
            <span class="tag">Curriculum</span>
            <h2 style="margin:0">é¸æ“‡ç·´ç¿’é—œå¡</h2>
          </div>
          <div class="pillMini">ç©å®¶ï¼š<span id="menuPlayer">---</span></div>
        </div>

        <div class="levelCards" id="levelCards"></div>

        <div class="panel">
          <h3 style="margin-top:0; font-size:0.9rem">ç·´ç¿’é›£åº¦</h3>
          <div style="display: flex; gap: 12px; flex-wrap:wrap;" id="diffSeg"></div>
        </div>

        <div style="margin-top: 32px; display: flex; gap: 16px; flex-wrap:wrap;">
          <button class="btn good" id="btnStart" style="flex: 1; justify-content:center; padding: 16px; border-radius: 14px; min-width: 220px;">
            é–‹å§‹ 60 ç§’æŒ‘æˆ°
          </button>
        </div>

        <div class="sep" style="height:1px; background:#e2e8f0; margin:40px 0"></div>
        
        <h3 style="font-size: 0.9rem; color: var(--text-muted);">æ’è¡Œæ¦œ TOP 10</h3>
        <table class="lb">
          <thead>
            <tr><th>åæ¬¡</th><th>ç©å®¶åç¨±</th><th style="text-align:right">å¾—åˆ†</th></tr>
          </thead>
          <tbody id="lbBody"></tbody>
        </table>
      </div>
    </section>

    <section class="screen" id="screenGame">
      <div class="hudRow">
        <div class="pillMini"><i class="fa-solid fa-clock"></i> <span id="timeLeft">60</span>s</div>
        <div class="pillMini"><i class="fa-solid fa-fire"></i> Combo <span id="combo">0</span></div>
        <div class="pillMini" style="background: var(--primary); color:white; border:none;">Score: <span id="score">0</span></div>
      </div>

      <div class="timeBar"><div class="timeFill" id="timeFill"></div></div>

      <div class="card" id="content"></div>

      <div class="gameActions">
        <button class="btn" id="btnPause">
          <i class="fa-solid fa-pause"></i> æš«åœ
        </button>

        <button class="btn" id="btnBackToMenu">
          <i class="fa-solid fa-list-check"></i> å›é¸æ“‡ç·´ç¿’é—œå¡
        </button>
      </div>
    </section>
  </div>

  <div class="overlay" id="pauseOverlay">
    <div class="modal">
      <h2 style="margin-top:0">ç·´ç¿’æš«åœ</h2>
      <p style="color:var(--text-muted)">æ·±å‘¼å¸ï¼Œæº–å‚™å¥½å†ç¹¼çºŒã€‚</p>
      <div style="display:flex; gap:12px; justify-content:center; margin-top:32px; flex-wrap:wrap;">
        <button class="btn good" id="btnResume" style="border-radius: 14px;">ç¹¼çºŒç·´ç¿’</button>
        <button class="btn" id="btnRestart" style="border-radius: 14px;">é‡ä¾†</button>
        <button class="btn" id="btnQuitNoSave" style="border-radius: 14px;">çµæŸå›é¸å–®</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="resultOverlay">
    <div class="modal">
      <span class="tag">Session Complete</span>
      <h2 id="finalScore" style="font-size:3.5rem; margin:10px 0; font-weight:800">0</h2>
      <p id="resultTitle" style="font-weight:700">å®ŒæˆæŒ‘æˆ°ï¼</p>
      <div id="starLine" style="font-size:1.5rem; color:#f59e0b; margin:16px 0"></div>
      <p id="starHint" style="color:var(--text-muted); font-size:0.9rem"></p>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:32px">
        <button class="btn good" id="btnPlayAgain" style="border-radius: 14px;">å†è©¦ä¸€æ¬¡</button>
        <button class="btn" id="btnBackMenu" style="border-radius: 14px;">å›åˆ°é¸å–®</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-pill">
      <div class="footer-left">
        <div class="footer-dot" aria-hidden="true"></div>
        <div class="footer-copy">Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.</div>
      </div>
      <div class="footer-right">
        <div class="footer-icon" aria-hidden="true"><i class="fas fa-compass"></i></div>
        <div class="footer-tagline">æ•¸å­¸ä¸è¿·è·¯ï¼ŒJessie å¸¶ä½ èµ°å‘ç†è§£ã€‚</div>
      </div>
    </div>
  </footer>

  <script>
    const $ = (s, el=document)=>el.querySelector(s);
    const $$ = (s, el=document)=>Array.from(el.querySelectorAll(s));

    function beep(type="good"){
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type = "sine";
      const t = ctx.currentTime;
      o.frequency.setValueAtTime(type==="good"?660:220, t);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.1, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t+0.18);
      o.start(t); o.stop(t+0.2);
      setTimeout(()=>ctx.close(), 250);
    }

    const DIFFS = [
      {id:"slow", name:"æ…¢é€Ÿ", base:10, icon:"fa-feather"},
      {id:"normal", name:"æ¨™æº–", base:12, icon:"fa-bolt"},
      {id:"fast", name:"æ¥µé€Ÿ", base:14, icon:"fa-rocket"},
    ];

    const state = {
      screen:"intro", player:"", level:1, diff:"normal",
      mode:"menu", timeLeft:60, timerId:null, paused:false,
      score:0, combo:0,
      l1:{}, l2:{}, l3:{}
    };

    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function gcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ [a,b]=[b,a%b]; } return a||1; }
    function reduceFrac(n,d){ const g=gcd(n,d); return {n:n/g, d:d/g}; }

    function fracHTML(n,d,cls=""){
      return `<div class="frac ${cls}"><div>${n}</div><div class="line"></div><div>${d}</div></div>`;
    }
    function fmtFrac(o){ return `${o.n}/${o.d}`; }

    function showScreen(key){
      $$(".screen").forEach(s => s.classList.remove("active"));
      $("#screen"+key.charAt(0).toUpperCase()+key.slice(1)).classList.add("active");
    }

    function updateHUD(){
      $("#timeLeft").textContent = state.timeLeft;
      $("#score").textContent = state.score;
      $("#combo").textContent = state.combo;
      $("#menuPlayer").textContent = state.player || "---";
      const ratio = state.timeLeft / 60;
      $("#timeFill").style.transform = `scaleX(${ratio})`;
    }

    const LB_KEY = "JM_V9_FUTURISM";
    function getLB(){ return JSON.parse(localStorage.getItem(`${LB_KEY}_${state.level}_${state.diff}`) || "[]"); }
    function saveToLB(){
      const lb = getLB();
      lb.push({ name: state.player, score: state.score, ts: Date.now() });
      lb.sort((a,b)=>b.score-a.score);
      localStorage.setItem(`${LB_KEY}_${state.level}_${state.diff}`, JSON.stringify(lb.slice(0,10)));
    }

    function renderMenu(){
      showScreen("menu");

      $("#levelCards").innerHTML = [
        {id:1, t:"åˆ†æ•¸ Ã· æ•´æ•¸", i:"fa-divide"},
        {id:2, t:"æ•´æ•¸ Ã— åˆ†æ•¸", i:"fa-xmark"},
        {id:3, t:"æ‹–æ‹‰èªæ„", i:"fa-hand-pointer"}
      ].map(l => `
        <div class="lvl ${state.level===l.id?'active':''}" onclick="state.level=${l.id};renderMenu()">
          <i class="fa-solid ${l.i}"></i>
          <b>${l.t}</b>
        </div>
      `).join("");

      $("#diffSeg").innerHTML = DIFFS.map(d => `
        <button class="btn ${state.diff===d.id?'good':''}" onclick="state.diff='${d.id}';renderMenu()">
          <i class="fa-solid ${d.icon}"></i> ${d.name}
        </button>
      `).join("");

      const lb = getLB();
      $("#lbBody").innerHTML = lb.length ? lb.map((r,i)=>`
        <tr><td class="rankCell">#${i+1}</td><td>${r.name}</td><td style="text-align:right"><b>${r.score}</b></td></tr>
      `).join("") : '<tr><td colspan="3" style="text-align:center;color:var(--text-muted);padding:20px;">å°šç„¡è¨˜éŒ„</td></tr>';
      updateHUD();
    }

    function shuffle(arr){ return arr.sort(()=>Math.random()-0.5); }

    function newQuestion(){
      if(state.level===1) {
        // âœ… çœŸéš¨æ©Ÿï¼šé¿å…å¹²æ“¾é¸é …æ’ç­”æ¡ˆ
        let q = randInt(2,10);
        let p = randInt(1,q-1);
        let k = randInt(2,9);
        const ans = reduceFrac(p, q*k);

        const wrongA = reduceFrac(p, q);                 // å¿˜äº† Ã·k
        const wrongB = reduceFrac(p*k, q);               // ä¹˜ k
        const wrongC = reduceFrac(p, q*(k+1));           // åˆ†æ¯å¤šä¹˜éŒ¯
        const options = uniqueFracShuffle([ans, wrongA, wrongB, wrongC], ans);

        state.l1 = { p, q, k, ans, options, locked:false };
        renderL1();
      } else if(state.level===2) {
        let m = randInt(2,12);
        let b = randInt(2,12);
        let a = 1;
        const ans = reduceFrac(m*a, b);

        const wrongA = reduceFrac(m, b-1<=1?b+1:b-1);
        const wrongB = reduceFrac(m, b+1);
        const wrongC = reduceFrac(m*b, b);               // è®Šå› mï¼ˆéŒ¯æŠŠä¹˜å€’æ•¸ç•¶ä¹˜åˆ†æ¯ï¼‰
        const options = uniqueFracShuffle([ans, wrongA, wrongB, wrongC], ans);

        state.l2 = { m, a, b, ans, options, locked:false };
        renderL2();
      } else {
        const mode = Math.random() < 0.5 ? "A" : "B";
        state.l3 = { mode };
        if(mode === "A") buildL3A();
        else buildL3B();
      }
    }

    function sameFrac(x,y){ return x.n===y.n && x.d===y.d; }
    function uniqueFracShuffle(list, ans){
      // å»é‡ï¼‹è£œé½Šï¼ˆé¿å…äº‚æ•¸æ’åˆ°ä¸€æ¨£çš„åˆ†æ•¸ï¼‰
      const out = [];
      for(const f of list){
        if(!out.some(o=>sameFrac(o,f))) out.push(f);
      }
      while(out.length < 4){
        // éš¨æ©Ÿè£œå¹²æ“¾
        const n = randInt(1,9);
        const d = randInt(2,12);
        const f = reduceFrac(n,d);
        if(!out.some(o=>sameFrac(o,f)) && !sameFrac(f, ans)) out.push(f);
      }
      return shuffle(out).slice(0,4);
    }

    function renderL1(){
      const {p,q,k,options} = state.l1;
      $("#content").innerHTML = `
        <span class="tag">Level 1: åˆ†æ•¸é™¤ä»¥æ•´æ•¸</span>
        <div class="equation">
          ${fracHTML(p,q)} <span style="color:var(--text-muted)">Ã·</span> <div class="box">${k}</div>
        </div>

        <div id="l12Feedback"></div>

        <div class="quick">
          ${options.map((o,i)=>`<button class="qbtn" onclick="checkAns(${i})" aria-label="é¸é … ${i+1}">${fracHTML(o.n,o.d,"sm")}</button>`).join("")}
        </div>
      `;
    }

    function renderL2(){
      const {m,a,b,options} = state.l2;
      $("#content").innerHTML = `
        <span class="tag">Level 2: æ•´æ•¸ä¹˜ä»¥å¹¾åˆ†ä¹‹ä¸€</span>
        <div class="equation">
          <div class="box">${m}</div> <span style="color:var(--text-muted)">Ã—</span> ${fracHTML(a,b)}
        </div>

        <div id="l12Feedback"></div>

        <div class="quick">
          ${options.map((o,i)=>`<button class="qbtn" onclick="checkAns(${i})" aria-label="é¸é … ${i+1}">${fracHTML(o.n,o.d,"sm")}</button>`).join("")}
        </div>
      `;
    }

    function showBigFeedbackL12(ok, ansFracHTML, gain){
      const fb = $("#l12Feedback");
      if(!fb) return;
      fb.innerHTML = `
        <div class="bigFeedback ${ok?'ok':'bad'}">
          ${ok ? 'âœ… æ­£ç¢ºï¼' : 'âŒ éŒ¯èª¤ï¼'}<br>
          <span style="color:#475569;font-weight:900;">æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š</span>
          <div class="answerLine">${ansFracHTML}</div>
          ${ok ? `<div style="margin-top:8px; font-size:1.05rem;">+${gain} åˆ†</div>` : ``}
        </div>
      `;
    }

    window.checkAns = (idx) => {
      const cur = state.level===1 ? state.l1 : state.l2;
      if(cur.locked) return;
      cur.locked = true;

      const picked = cur.options[idx];
      const isCorrect = (picked.n === cur.ans.n && picked.d === cur.ans.d);
      const gain = DIFFS.find(d=>d.id===state.diff).base;
      const ansHTML = fracHTML(cur.ans.n, cur.ans.d);

      if(isCorrect){
        state.score += gain;
        state.combo++;
        beep("good");
        showBigFeedbackL12(true, ansHTML, gain);
        updateHUD();
        setTimeout(()=>{ cur.locked=false; newQuestion(); }, 650);
      } else {
        state.combo = 0;
        beep("bad");
        showBigFeedbackL12(false, ansHTML, gain);
        updateHUD();
        setTimeout(()=>{ cur.locked=false; newQuestion(); }, 1000);
      }
    };

    /* ===== L3-A ===== */
    function buildL3A(){
      const q = randInt(2,10);
      const p = randInt(1,q-1);
      const k = randInt(2,9);
      const correct = reduceFrac(1, k);

      const wrong1 = reduceFrac(k, 1);
      const wrong2 = reduceFrac(1, k+1);
      const wrong3 = reduceFrac(1, Math.max(2, k-1));
      const options = uniqueFracShuffle([correct, wrong1, wrong2, wrong3], correct);

      state.l3 = {
        mode:"A",
        p, q, k,
        correct,
        options,
        locked: false
      };
      renderL3A();
    }

    function renderL3A(){
      const {p,q,k,options} = state.l3;

      $("#content").innerHTML = `
        <span class="tag">Level 3: æ‹–æ‹‰èªæ„</span>

        <div class="l3Wrap">
          <div class="l3TopHint">
            <i class="fa-solid fa-hand-pointer" style="color:var(--primary)"></i>
            æŠŠã€Œé™¤ä»¥ <b>${k}</b>ã€æ”¹å¯«æˆã€Œä¹˜ä»¥å€’æ•¸ã€ï¼Œæ‹–æ‹‰æ­£ç¢ºåˆ†æ•¸åˆ°ç©ºæ ¼
          </div>

          <div class="equation" style="padding: 18px 0 10px;">
            ${fracHTML(p,q)} <span style="color:var(--text-muted)">Ã·</span> <div class="box">${k}</div>
            <span style="color:var(--text-muted)">ï¼</span>
            ${fracHTML(p,q)} <span style="color:var(--text-muted)">Ã—</span>
            <div class="dropSlot" id="dropSlot" aria-label="æ‹–æ‹‰åˆ°é€™è£¡">æ‹–åˆ°é€™è£¡</div>
          </div>

          <div id="l3Feedback"></div>

          <div class="dragGrid" id="dragGrid">
            ${options.map((o,i)=>`
              <div class="dragChip" draggable="true" data-idx="${i}" aria-label="æ‹–æ‹‰é¸é … ${i+1}">
                ${fracHTML(o.n,o.d,"sm")}
              </div>
            `).join("")}
          </div>
        </div>
      `;
      wireL3A();
    }

    function wireL3A(){
      const slot = $("#dropSlot");
      const chips = $$("#dragGrid .dragChip");

      const lockUI = () => {
        chips.forEach(c => c.classList.add("locked"));
        chips.forEach(c => c.setAttribute("draggable","false"));
      };

      chips.forEach(chip => {
        chip.addEventListener("dragstart", (e)=>{
          if(state.l3.locked) return;
          e.dataTransfer.setData("text/plain", chip.dataset.idx);
          setTimeout(()=>chip.style.opacity="0.6", 0);
        });
        chip.addEventListener("dragend", ()=> chip.style.opacity="1");

        chip.addEventListener("click", ()=>{
          if(state.l3.locked) return;
          checkL3A(Number(chip.dataset.idx), lockUI);
        });
      });

      slot.addEventListener("dragover", (e)=>{
        e.preventDefault();
        if(state.l3.locked) return;
        slot.classList.add("hover");
      });
      slot.addEventListener("dragleave", ()=> slot.classList.remove("hover"));
      slot.addEventListener("drop", (e)=>{
        e.preventDefault();
        slot.classList.remove("hover");
        if(state.l3.locked) return;
        const idx = Number(e.dataTransfer.getData("text/plain"));
        checkL3A(idx, lockUI);
      });
    }

    function checkL3A(idx, lockUI){
      const cur = state.l3;
      const picked = cur.options[idx];
      const isCorrect = (picked.n === cur.correct.n && picked.d === cur.correct.d);

      cur.locked = true;
      lockUI();

      const fb = $("#l3Feedback");
      const correctText = `${cur.correct.n}/${cur.correct.d}`;
      const gain = DIFFS.find(d=>d.id===state.diff).base;

      if(isCorrect){
        state.score += gain;
        state.combo++;
        beep("good");

        fb.innerHTML = `
          <div class="bigFeedback ok">
            âœ… æ­£ç¢ºï¼<br>
            <span style="color:var(--text-muted); font-weight:900;">é™¤ä»¥ ${cur.k} ï¼ ä¹˜ä»¥ ${correctText}</span><br>
            <span style="font-size:1.1rem;">+${gain} åˆ†</span>
          </div>
        `;
      } else {
        state.combo = 0;
        beep("bad");

        fb.innerHTML = `
          <div class="bigFeedback bad">
            âŒ éŒ¯èª¤ï¼<br>
            æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š<b>${correctText}</b><br>
            <span style="color:var(--text-muted); font-weight:900;">æ‰€ä»¥ Ã· ${cur.k} è¦æ”¹å¯«æˆ Ã— ${correctText}</span>
          </div>
        `;
      }

      updateHUD();
      setTimeout(()=>newQuestion(), isCorrect ? 650 : 1050);
    }

    /* ===== L3-B ===== */
    function buildL3B(){
      const m = randInt(8, 48);
      const b = randInt(2, 9);
      const a = 1;

      const cards = shuffle([
        {id:"mul1", text:`æŠŠ ${m} è®Šæˆ ${a}/${b} å€`, target:"mul"},
        {id:"mul2", text:`å–å‡º ${m} çš„ ${a}/${b}`, target:"mul"},
        {id:"div1", text:`æŠŠ ${m} å¹³å‡åˆ†æˆ ${b} ä»½`, target:"div"},
        {id:"div2", text:`æŠŠ ${m} ä¾ ${b} ç­‰åˆ†`, target:"div"},
      ]);

      state.l3 = {
        mode:"B",
        m, a, b,
        cards,
        placed: { mul:null, div:null },
        locked:false
      };
      renderL3B();
    }

    function renderL3B(){
      const {m,a,b,cards,placed} = state.l3;

      $("#content").innerHTML = `
        <span class="tag">Level 3: æ‹–æ‹‰èªæ„</span>

        <div class="equation" style="padding: 16px 0 8px; gap: 14px;">
          <div class="box">${m}</div>
          <span style="color:var(--text-muted)">Ã—</span>
          ${fracHTML(a,b)}
          <span style="color:var(--text-muted); font-size:1.2rem; font-weight:900;">èˆ‡</span>
          <div class="box">${m}</div>
          <span style="color:var(--text-muted)">Ã·</span>
          <div class="box">${b}</div>
        </div>

        <div class="l3bGrid">
          <div class="l3bBox">
            <p class="l3bTitle"><i class="fa-solid fa-hand-pointer"></i> èªæ„å¡ç‰‡ï¼ˆæ‹–æ‹‰ï¼‰</p>
            <p class="l3bSub">æŠŠå¡ç‰‡æ‹–åˆ°å³é‚Šçš„é…å°æ§½ï¼ˆä½ é…çš„æ˜¯ã€Œæ„æ€ã€ï¼Œä¸æ˜¯ç®—çµæœï¼‰ã€‚</p>

            <div class="meaningCards" id="meaningCards">
              ${cards.map(c=>`
                <div class="meaningCard" draggable="true" data-id="${c.id}" aria-label="èªæ„å¡ ${c.text}">
                  <i class="fa-solid fa-hand"></i>
                  <span>${c.text}</span>
                </div>
              `).join("")}
            </div>
          </div>

          <div class="l3bBox">
            <p class="l3bTitle"><i class="fa-solid fa-square-check"></i> é…å°æ§½</p>
            <p class="l3bSub">æ‹–åˆ°æ§½ä½å°±æœƒæ”¾ä¸Šå»ã€‚</p>

            <div class="pairArea">
              <div class="pairSlot" id="slotMul" data-slot="mul">
                <div class="slotHead">
                  <span class="slotBadge"><i class="fa-solid fa-xmark"></i> Ã— ${a}/${b}</span>
                  <span style="color:var(--text-muted); font-weight:900;">æ‹–åˆ°é€™è£¡</span>
                </div>
                <div class="slotFill" id="slotMulFill">
                  ${placed.mul ? placed.mul.text : `<span class="slotEmpty">å°šæœªæ”¾å…¥</span>`}
                </div>
              </div>

              <div class="pairSlot" id="slotDiv" data-slot="div">
                <div class="slotHead">
                  <span class="slotBadge"><i class="fa-solid fa-divide"></i> Ã· ${b}</span>
                  <span style="color:var(--text-muted); font-weight:900;">æ‹–åˆ°é€™è£¡</span>
                </div>
                <div class="slotFill" id="slotDivFill">
                  ${placed.div ? placed.div.text : `<span class="slotEmpty">å°šæœªæ”¾å…¥</span>`}
                </div>
              </div>

              <div class="pairActions">
                <button class="btnGreen" id="btnSubmitPair"><i class="fa-solid fa-check"></i> é€å‡º</button>
                <button class="btnGray" id="btnResetPair"><i class="fa-solid fa-rotate-left"></i> é‡ç½®</button>
              </div>

              <div id="l3Feedback"></div>
            </div>
          </div>
        </div>
      `;

      wireL3B();
    }

    function wireL3B(){
      const cardsEls = $$("#meaningCards .meaningCard");
      const slotMul = $("#slotMul");
      const slotDiv = $("#slotDiv");

      const wireSlot = (slotEl)=>{
        slotEl.addEventListener("dragover", (e)=>{
          e.preventDefault();
          if(state.l3.locked) return;
          slotEl.classList.add("hover");
        });
        slotEl.addEventListener("dragleave", ()=> slotEl.classList.remove("hover"));
        slotEl.addEventListener("drop", (e)=>{
          e.preventDefault();
          slotEl.classList.remove("hover");
          if(state.l3.locked) return;
          const id = e.dataTransfer.getData("text/plain");
          placeCardToSlot(id, slotEl.dataset.slot);
        });
      };
      wireSlot(slotMul);
      wireSlot(slotDiv);

      cardsEls.forEach(el=>{
        el.addEventListener("dragstart", (e)=>{
          if(state.l3.locked) return;
          e.dataTransfer.setData("text/plain", el.dataset.id);
          setTimeout(()=> el.style.opacity="0.6", 0);
        });
        el.addEventListener("dragend", ()=> el.style.opacity="1");

        el.addEventListener("click", ()=>{
          if(state.l3.locked) return;
          if(!state.l3.placed.mul) placeCardToSlot(el.dataset.id, "mul");
          else if(!state.l3.placed.div) placeCardToSlot(el.dataset.id, "div");
          else placeCardToSlot(el.dataset.id, "mul");
        });
      });

      $("#btnResetPair").onclick = ()=>{
        if(state.l3.locked) return;
        state.l3.placed = {mul:null, div:null};
        renderL3B();
      };

      $("#btnSubmitPair").onclick = ()=>{
        if(state.l3.locked) return;
        submitL3B();
      };
    }

    function placeCardToSlot(cardId, slot){
      const card = state.l3.cards.find(c=>c.id===cardId);
      if(!card) return;

      state.l3.placed[slot] = card;
      const other = slot === "mul" ? "div" : "mul";
      if(state.l3.placed[other] && state.l3.placed[other].id === cardId){
        state.l3.placed[other] = null;
      }
      renderL3B();
    }

    function submitL3B(){
      const fb = $("#l3Feedback");
      const {placed} = state.l3;

      if(!placed.mul || !placed.div){
        fb.innerHTML = `<div class="bigFeedback bad">å…ˆæŠŠå…©å€‹æ§½éƒ½æ”¾ä¸Šèªæ„å¡å†é€å‡ºå–”ï¼</div>`;
        beep("bad");
        state.combo = 0;
        updateHUD();
        return;
      }

      state.l3.locked = true;

      const ok = (placed.mul.target === "mul") && (placed.div.target === "div");
      const gain = DIFFS.find(d=>d.id===state.diff).base;

      if(ok){
        state.score += gain;
        state.combo++;
        beep("good");
        fb.innerHTML = `
          <div class="bigFeedback ok">
            âœ… é…å°æ­£ç¢ºï¼<br>
            <span style="color:var(--text-muted); font-weight:900;">ä½ æŠ“åˆ°çš„æ˜¯ã€Œèªæ„ä½ç½®ã€</span><br>
            <span style="font-size:1.1rem;">+${gain} åˆ†</span>
          </div>
        `;
        updateHUD();
        setTimeout(()=>newQuestion(), 800);
      } else {
        state.combo = 0;
        beep("bad");

        const correctMul = state.l3.cards.find(c=>c.target==="mul").text;
        const correctDiv = state.l3.cards.find(c=>c.target==="div").text;

        fb.innerHTML = `
          <div class="bigFeedback bad">
            âŒ é…å°éŒ¯èª¤ï¼<br>
            <span style="color:var(--text-muted); font-weight:900;">Ã— 1/${state.l3.b} æ‡‰å°æ‡‰ï¼š</span><br>
            <b>${correctMul}</b><br><br>
            <span style="color:var(--text-muted); font-weight:900;">Ã· ${state.l3.b} æ‡‰å°æ‡‰ï¼š</span><br>
            <b>${correctDiv}</b>
          </div>
        `;
        updateHUD();
        setTimeout(()=>newQuestion(), 1200);
      }
    }

    function startRound(){
      state.score = 0; state.timeLeft = 60; state.combo = 0; state.mode = "play";
      showScreen("game");
      updateHUD();
      newQuestion();
      clearInterval(state.timerId);
      state.timerId = setInterval(()=>{
        if(state.paused) return;
        state.timeLeft--;
        updateHUD();
        if(state.timeLeft<=0) endRound();
      }, 1000);
    }

    function endRound(){
      clearInterval(state.timerId);
      saveToLB();
      $("#finalScore").textContent = state.score;
      $("#resultOverlay").classList.add("show");
    }

    function backToMenu(){
      clearInterval(state.timerId);
      state.paused = false;
      $("#pauseOverlay").classList.remove("show");
      $("#resultOverlay").classList.remove("show");
      renderMenu();
    }

    const nameInput = $("#nameInput");
    const btnGoMenu = $("#btnGoMenu");

    function setGoMenuEnabled(enabled){
      if(enabled){
        btnGoMenu.disabled = false;
        btnGoMenu.classList.remove("disabled");
      }else{
        btnGoMenu.disabled = true;
        btnGoMenu.classList.add("disabled");
      }
    }
    function normalizeName(v){ return (v || "").trim().replace(/\s+/g, " "); }

    setGoMenuEnabled(false);
    nameInput.addEventListener("input", () => {
      const v = normalizeName(nameInput.value);
      setGoMenuEnabled(v.length > 0);
    });

    btnGoMenu.onclick = () => {
      const v = normalizeName(nameInput.value);
      if(!v){
        setGoMenuEnabled(false);
        nameInput.focus();
        nameInput.style.boxShadow = "0 0 0 4px rgba(244, 63, 94, 0.18)";
        setTimeout(()=> nameInput.style.boxShadow = "", 350);
        return;
      }
      state.player = v;
      renderMenu();
    };

    $("#btnStart").onclick = startRound;

    $("#btnPause").onclick = () => { state.paused = true; $("#pauseOverlay").classList.add("show"); };
    $("#btnResume").onclick = () => { state.paused = false; $("#pauseOverlay").classList.remove("show"); };
    $("#btnRestart").onclick = () => { $("#pauseOverlay").classList.remove("show"); state.paused = false; startRound(); };

    $("#btnQuitNoSave").onclick = () => { location.reload(); };
    $("#btnBackToMenu").onclick = backToMenu;

    $("#btnBackMenu").onclick = () => { location.reload(); };
    $("#btnPlayAgain").onclick = () => { $("#resultOverlay").classList.remove("show"); startRound(); };
  </script>
</body>
</html>
